from flask import Flask, request, abort, send_from_directory
import os.path, json, functools
app = Flask(__name__)

relpath = lambda path: os.path.join(os.path.dirname(os.path.realpath(__file__)), path)

with open(relpath("../params.json")) as f:
	params = json.load(f)

def secret(f):
	@functools.wraps(f)
	def wrapper(*args, **kwargs):
		print('check')
		if request.args.get('secret') == params["secret"]:
			return f(*args, **kwargs)
		else:
			abort(401)
	return wrapper

@app.route('/upload/replay', methods = ["POST"])
@secret
def upload_replay():
	upload(False, "phlt", "replays")
	return ""

@app.route('/upload/weights', methods = ["POST"])
@secret
def upload_weights():
	upload("actor.ckpt")
	return ""

def upload(fname = False, ext = False, path = False):
	for f in request.files.values():
		print(f)
		if f == None or f.filename == "":
			abort(400)
		fname = fname or ((f.filename.rsplit(".", 1)[0] if "." in f.filename else "") + ext if ext else f.filename)
		f.save(os.path.join(relpath("replays"), fname) if path else relpath(fname))

@app.route('/download/replay/<filename>')
@secret
def download_replay(filename):
	return send_from_directory(relpath('replays'), filename + ".phlt")

@app.route('/download/weights')
@secret
def download_weights():
	return app.send_static_file(relpath('actor.ckpt'))

if __name__ == "__main__":
	app.run(port = 8000, debug = False, threaded = True)
